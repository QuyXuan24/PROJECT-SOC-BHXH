version: '3.8'

services:
  # ==========================================
  # 1. DATABASE - SQL SERVER 
  # ==========================================
  database:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: bhxh_sql_server
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=${DB_PASSWORD} # Lấy từ file .env
    ports:
      - "1433:1433"
    volumes:
      - ./sql_data:/var/opt/mssql # Volume giữ dữ liệu SQL
    networks:
      - bhxh_network
    restart: always

  # ==========================================
  # 2. BACKEND - ASP.NET CORE API
  # ==========================================
  backend:
    build:
      # QUAN TRỌNG: Trỏ đúng vào folder chứa dự án .NET và Dockerfile mới
      context: ./backend/BHXH_Backend
      dockerfile: Dockerfile
    container_name: bhxh_api_core
    environment:
      # Connection String chuẩn cho .NET kết nối SQL Server
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DefaultConnection=Server=database,1433;Database=BHXH_DB;User Id=sa;Password=${DB_PASSWORD};TrustServerCertificate=True;
      - AES_KEY=${AES_KEY}       # Cho Task 11 (Mã hóa)
      - JWT_SECRET=${JWT_SECRET} # Cho Task 10 (Token)
    ports:
      - "5000:8080" # Map cổng 5000 máy bạn vào cổng 8080 của container .NET
    depends_on:
      - database
    networks:
      - bhxh_network
    restart: on-failure

  # ==========================================
  # 3. FRONTEND - DASHBOARD
  # ==========================================
  frontend:
    build: ./frontend
    container_name: bhxh_frontend
    ports:
      - "3000:3000"
    stdin_open: true
    tty: true
    depends_on:
      - backend
    networks:
      - bhxh_network
    restart: always

  # ==========================================
  # 4. NGINX - REVERSE PROXY
  # ==========================================
  nginx:
    image: nginx:alpine
    container_name: bhxh_nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - backend
      - frontend
    networks:
      - bhxh_network

# Khai báo Volume
volumes:
  sql_data:

# Khai báo Network để các container nhìn thấy nhau
networks:
  bhxh_network:
    driver: bridge